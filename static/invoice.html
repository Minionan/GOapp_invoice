<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Form</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1 style="font-family:verdana">Invoice Form</h1>
    <form id="invoiceForm">
        <fieldset>
            <legend>Billed to:</legend>
            <label><strong>Client Name:</strong></label>
            <select id="client-dropdown">
                <option value="">Choose client...</option>
            </select>
            <div id="client-details"></div>
        </fieldset><br>
        <fieldset>
            <legend>Invoice Details</legend>
            <label for="invoiceDate"><strong>Date:</strong></label>
            <input type="date" id="invoiceDate"><br><br>
            <label>Invoice Number:</label>
            <input type="text" id="invoiceNumber" readonly><br><br>
            <div id="job-labels">
                <label style="margin-left: 40px; margin-right: 120px;">Job Description</label>
                <label style="margin-right: 115px;">Quantity</label>
                <label style="margin-right: 135px;">Price</label>
                <label>Full Price</label>
            </div>
            <div id="job-rows">
                <div class="job-row">
                    <select class="job-dropdown"></select>
                    <input type="number" class="quantity" placeholder="Quantity" min="0">
                    <input type="number" class="price" placeholder="Price" min="0">
                    <input type="number" class="fullPrice" placeholder="Full Price" readonly>
                </div>
            </div>
            <button type="button" id="add-job">Add Job</button><br><br>
            <label>Job cost:</label>
            <input type="number" id="cost" readonly><br><br>
            <label>VAT (5%):</label>
            <input type="number" id="vat" readonly><br><br>
            <label>Total Amount:</label>
            <input type="number" id="total" readonly><br>
        </fieldset><br>
        <input type="button" id="generate-txt" value="Generate TXT file">
        <br><br>
        <fieldset>
            <legend>How to use:</legend>
            <label>
                1. Choose the Client Name.<br>
                2. Choose the Date.<br>
                3. Add and fill in the Jobs description, Quantity and Price.<br>
                4. Generate TXT file with all the filled details and invoice number as a file name.
            </label>
        </fieldset><br>
    </form>

    <script>
        $(document).ready(function() {
            // Load jobs data
            $.getJSON('/jobs', function(data) {
                window.jobsData = data;
                updateJobDropdowns();
            });

            // Load clients data
            $.getJSON('/clients', function(data) {
                window.clientsData = data;
                var clientDropdown = $('#client-dropdown');
                data.forEach(function(client) {
                    clientDropdown.append($('<option>', {
                        value: client.abbreviation,
                        text: client.clientName
                    }));
                });
            });

            function updateJobDropdowns() {
                $('.job-dropdown').each(function() {
                    var dropdown = $(this);
                    // Only update if the dropdown is empty or has no selection
                    if (!dropdown.val()) {
                        dropdown.empty();
                        dropdown.append($('<option>', {
                            value: "",
                            text: "Please choose a job..."
                        }));
                        if (window.jobsData) {
                            window.jobsData.forEach(function(job) {
                                dropdown.append($('<option>', {
                                    value: job.jobName,
                                    text: job.jobName,
                                    'data-price': job.price
                                }));
                            });
                        }
                    }
                });
            }

            function updateClientDetailsAndInvoiceNumber() {
                let selectedClient = $('#client-dropdown').val();
                let selectedDate = $('#invoiceDate').val();
                
                // Clear fields if no client selected
                if (!selectedClient || !window.clientsData) {
                    $('#client-details').html('');
                    $('#invoiceNumber').val('');
                    return;
                }

                // Update client details
                let client = window.clientsData.find(c => c.abbreviation === selectedClient);
                if (client) {
                    $('#client-details').html(
                        '<strong>Parent Name:</strong> ' + client.parentName + '<br>' +
                        '<strong>Address 1:</strong> ' + client.address1 + '<br>' +
                        (client.address2 ? '<strong>Address 2:</strong> ' + client.address2 + '<br>' : '') +
                        '<strong>Phone:</strong> ' + client.phone + '<br>' +
                        '<strong>Email:</strong> ' + client.email
                    );
                    
                    // Update invoice number if date is selected
                    if (selectedDate) {
                        let dateObj = new Date(selectedDate);
                        let year = dateObj.getFullYear();
                        let month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        $('#invoiceNumber').val(`${year}_${month}_${client.abbreviation}`);
                    } else {
                        $('#invoiceNumber').val('');
                    }
                }
            }

            // Event Handlers
            $('#client-dropdown, #invoiceDate').change(function() {
                updateClientDetailsAndInvoiceNumber();
            });

            $('#job-rows').on('change', '.job-dropdown', function() {
                var row = $(this).closest('.job-row');
                var selectedJob = window.jobsData.find(job => job.jobName === $(this).val());
                if (selectedJob) {
                    row.find('.price').val(selectedJob.price);
                    updateFullPrice(row);
                }
            });

            $('#add-job').click(function() {
                var jobRow = $('.job-row:first').clone();
                jobRow.find('.quantity, .price, .fullPrice').val('');
                jobRow.append('<button type="button" class="delete-row" style="margin-left: 10px;">Delete</button>');
                $('#job-rows').append(jobRow);
                updateJobDropdowns();
            });

            $('#job-rows').on('click', '.delete-row', function() {
                if ($('.job-row').length > 1) {
                    $(this).closest('.job-row').remove();
                    calculateTotals();
                }
            });

            $('#job-rows').on('input', '.quantity, .price', function() {
                var row = $(this).closest('.job-row');
                updateFullPrice(row);
            });

            $('#generate-txt').click(function() {
                // Check if invoice number is set
                if (!$('#invoiceNumber').val()) {
                    alert('Please select both client and date to generate invoice number before downloading the file.');
                    return;
                }

                // Check for empty or zero values in job rows
                let issues = [];
                let hasIssues = false;

                $('.job-row').each(function(index) {
                    const rowNum = index + 1;
                    const jobDescription = $(this).find('.job-dropdown').val();
                    const quantity = parseFloat($(this).find('.quantity').val()) || 0;
                    const price = parseFloat($(this).find('.price').val()) || 0;
                    const fullPrice = parseFloat($(this).find('.fullPrice').val()) || 0;

                    if (!jobDescription) {
                        issues.push(`Job ${rowNum}: Job Description is not selected`);
                        hasIssues = true;
                    }
                    if (quantity === 0) {
                        issues.push(`Job ${rowNum}: Quantity is zero`);
                        hasIssues = true;
                    }
                    if (price === 0) {
                        issues.push(`Job ${rowNum}: Price is zero`);
                        hasIssues = true;
                    }
                    if (fullPrice === 0) {
                        issues.push(`Job ${rowNum}: Full Price is zero`);
                        hasIssues = true;
                    }
                });

                if (hasIssues) {
                    const message = 'The following issues were found:\n\n' + 
                                issues.join('\n') + 
                                '\n\nDo you want to proceed with generating the file anyway?';
                    
                    if (!confirm(message)) {
                        return;
                    }
                }

                // Proceed with file generation if no issues or user confirmed
                var formData = {};
                formData.clientName = $('#client-dropdown').val();
                formData.invoiceDate = $('#invoiceDate').val();
                formData.invoiceNumber = $('#invoiceNumber').val();

                formData.job = [];
                $('.job-row').each(function() {
                    var jobDescription = $(this).find('.job-dropdown').val();
                    var quantity = $(this).find('.quantity').val();
                    var price = $(this).find('.price').val();
                    var fullPrice = $(this).find('.fullPrice').val();

                    formData.job.push({
                        description: jobDescription,
                        quantity: quantity,
                        price: price,
                        fullPrice: fullPrice
                    });
                });

                formData.cost = $('#cost').val();
                formData.vat = $('#vat').val();
                formData.total = $('#total').val();

                $.post('/generate-invoice', formData, function(data) {
                    var blob = new Blob([data], {type: 'text/plain'});
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = formData.invoiceNumber + '.txt';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                });
            });

            function calculateTotals() {
                var totalCost = 0;
                $('.job-row').each(function() {
                    totalCost += parseFloat($(this).find('.fullPrice').val()) || 0;
                });

                var vat = totalCost * 0.05;
                var totalAmount = totalCost + vat;

                $('#cost').val(totalCost.toFixed(2));
                $('#vat').val(vat.toFixed(2));
                $('#total').val(totalAmount.toFixed(2));
            }

            function updateFullPrice(row) {
                var quantity = parseFloat(row.find('.quantity').val()) || 0;
                var price = parseFloat(row.find('.price').val()) || 0;
                var fullPrice = quantity * price;
                row.find('.fullPrice').val(fullPrice.toFixed(2));
                calculateTotals();
            }
        });
    </script>
</body>
</html>
